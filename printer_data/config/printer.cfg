[include fluidd.cfg]

#####################################################################
#   Important other files
#####################################################################

[include Macros/*.cfg]

[include test_probe_accuracy.cfg]

[temperature_sensor MCU]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#[force_move]
#enable_force_move: True
#   Set to true to enable FORCE_MOVE and SET_KINEMATIC_POSITION
#   extended G-Code commands. The default is false.

[exclude_object]

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
#serial: /dev/serial/by-id/{REPLACE WITH YOUR SERIAL}
#serial: /dev/ttyAMA0
#baud: 250000
canbus_interface: can0
canbus_uuid: f3b0bfc05fbb
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_4700360009504B4633373520-if00
#restart_method: command
##--------------------------------------------------------------------

## can0
#[mcu can0]
##canbus_uuid: ac3ad854c4f1 # EBB36
#canbus_uuid: 007e88aeda12 # run the following command to locate the uuid >   ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0

[mcu CM4]
serial: /tmp/klipper_host_mcu

[mcu Toolhead]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_rp2040_4D4A39333616543B-if00
restart_method: command
##--------------------------------------------------------------------


[printer]
kinematics: corexy
max_velocity: 4000    # Was 3000
#max_velocity: 2000
max_accel: 4500                          #Max 4000
#max_accel: 10000                        #For resonance test
max_z_velocity: 50                      #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0


[idle_timeout]
#gcode:
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 7200
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.


#[gcode_macro _CLIENT_VARIABLE]
#variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
#variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
#variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
#variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
#variable_retract          : 1.0   ; the value to retract while PAUSE
#variable_cancel_retract   : 5.0   ; the value to retract while CANCEL_PRINT
#variable_speed_retract    : 35.0  ; retract speed in mm/s
#variable_unretract        : 1.0   ; the value to unretract while RESUME
#variable_speed_unretract  : 35.0  ; unretract speed in mm/s
#variable_speed_hop        : 15.0  ; z move speed in mm/s
#variable_speed_move       : 100.0 ; move speed in mm/s
#variable_park_at_cancel   : False ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
#variable_park_at_cancel_x : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
#variable_park_at_cancel_y : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
## !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
#variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
#variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
#variable_runout_sensor    : ""    ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
##                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
## !!! Custom macros, please use with care and review the section of the corresponding macro.
## These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
## Only  single line commands are supported, please create a macro if you need more than one command.
#variable_user_pause_macro : ""    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
#variable_user_resume_macro: ""    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
#variable_user_cancel_macro: ""    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
#gcode:


[board_pins mcu]
    # BTT Manta M8P v1.1
aliases:
aliases_drivers:
    DRV1_EN=PC11, DRV1_STEP=PE2,  DRV1_DIR=PB4,  DRV1_UART=PC10,
    DRV2_EN=PB3,  DRV2_STEP=PF12, DRV2_DIR=PF11, DRV2_UART=PF13,
    DRV3_EN=PF10, DRV3_STEP=PD7,  DRV3_DIR=PD6,  DRV3_UART=PF9,
    DRV4_EN=PD5,  DRV4_STEP=PD3,  DRV4_DIR=PD2,  DRV4_UART=PD4,
    DRV5_EN=PD1,  DRV5_STEP=PC9,  DRV5_DIR=PC8,  DRV5_UART=PD0,
    DRV6_EN=PA15, DRV6_STEP=PA10, DRV6_DIR=PA14, DRV6_UART=PF8,
    DRV7_EN=PD15, DRV7_STEP=PD11, DRV7_DIR=PD9,  DRV7_UART=PD14,
    DRV8_EN=PC7,  DRV8_STEP=PD8,  DRV8_DIR=PC6,  DRV8_UART=PD10
aliases_limitsw:
    M1_STOP = PF3,
    M2_STOP = PF4,
    M3_STOP = PF5,
    M4_STOP = PC0,
    M5_STOP = PC1,
    M6_STOP = PC2
aliases_rgb:
    RGB1    = PA9,
    RGB2    = PB15
aliases_fans:
    FAN0      = PE6,
    FAN1      = PE0,
    FAN2      = PC12,
    FAN3      = PE5,
    FAN4      = PE4,
    FAN5      = PC14,
    FAN5_TACH = PB8,
    FAN6      = PC15,
    FAN6_TACH = PB9,
    FAN_PI    = GPIO26
aliases_thermistors:
    TB   = PA0,
    TH0   = PA1,
    TH1   = PA2,
    TH2   = PA3,
    TH3   = PA4
aliases_heaters:
    HB   = PB7,
    HE0  = PE3,
    HE1  = PB5,
    HE2  = PB6,
    HE3  = PE1
aliases_servos:
    SRV1 = PE9
aliases_exp:
    # EXP1 header
    EXP1_1 = PE9,   EXP1_2  = PE10,
    EXP1_3 = PE11,  EXP1_4  = PE12,
    EXP1_5 = PE13,  EXP1_6  = PE14,    # Slot in the socket on this side
    EXP1_7 = PE15,  EXP1_8  = PB10,
    EXP1_9 = <GND>, EXP1_10 = <5V>,

    # EXP2 header
    EXP2_1 = PB14,  EXP2_2  = PB13,
    EXP2_3 = PF7,   EXP2_4  = PB12,
    EXP2_5 = PE7,   EXP2_6  = PB11,      # Slot in the socket on this side
    EXP2_7 = PE8,   EXP2_8  = <RST>,
    EXP2_9 = <GND>, EXP2_10 = <5V>


#[board_pins EBB_SB2209RP2040v1.0]
#mcu: can0
#aliases:
#aliases_step:
#    EXT_EN     = gpio17,
#    EXT_STEP   = gpio18,
#    EXT_DIR    = gpio19,
#    EXT_UART   = gpio20
#aliases_limitsw: # these are preferred for endstops (including klicky)
#    LIMIT_1    = gpio24
#aliases_bltouch:
#    BL_SENSE   = gpio21,
#    BL_CONTROL = gpio22
#aliases_fans:
#    FAN1       = gpio13,
#    FAN2       = gpio14,
#    FAN3       = gpio15,
#    FAN3_TACH  = gpio12
#aliases_thermistors:
#    TH0        = gpio27,
#    PT100_CS   = gpio9,
#    PT100_SCLK = gpio10,
#    PT100_MISO = gpio11,
#    PT100_MOSI = gpio8
#aliases_heaters:
#    HE0        = gpio7
#aliases_rgb:
#    RGBLED     = gpio16
#aliases_adxl:
#    ADXL_CS    = gpio1,
#    ADXL_SCLK  = gpio2,
#    ADXL_MISO  = gpio3,
#    ADXL_MOSI  = gpio0

[board_pins LDO_NitehawkSB]
mcu: Toolhead
aliases:
aliases_step:
    EXT_EN       = gpio25,
    EXT_STEP     = gpio23,
    EXT_DIR      = gpio24,
    EXT_UART     = gpio0,
    EXT_TX       = gpio1
aliases_limitsw:
    LIMIT_X      = gpio13,
    LIMIT_Y      = gpio12
aliases_thermistors:
    TH0          = gpio29,
    Chamber      = gpio28,
    Board        = gpio26
aliases_fans:
    FAN_HEF      = gpio5,
    FAN_HEF_TACH = gpio16,
    FAN_PCF      = gpio6,
    FAN_PCF_TACH = gpio17
aliases_rgb:
    RGBLED       = gpio7
aliases_heaters:
    HE0          = gpio9
aliases_adxl:
    ADXL_CS      = gpio21,
    ADXL_SCLK    = gpio18,
    ADXL_MISO    = gpio19,
    ADXL_MOSI    = gpio20
aliases_probe:
    PROBE        = gpio10
aliases_activity:
    ACT_LED      = gpio8



[temperature_sensor Toolhead]
sensor_type: temperature_mcu
sensor_mcu: Toolhead


#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR1
##  Endstop connected to MIN1 - Sensorless homing
[stepper_x]
step_pin: DRV1_STEP
dir_pin: DRV1_DIR
enable_pin: !DRV1_EN
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:400             #set to 400 for 0.9 degree stepper
position_min: 0
##--------------------------------------------------------------------

##    Uncomment for 300mm build
position_endstop: 300
position_max: 300

##--------------------------------------------------------------------
homing_positive_dir: true
endstop_pin: tmc2209_stepper_x:virtual_endstop
homing_retract_dist: 0
homing_speed: 75   #Max 100


[tmc2209 stepper_x]
uart_pin: DRV1_UART
#interpolate: true
interpolate: false
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 1
diag_pin: ^M1_STOP
driver_SGTHRS: 150


##  A Stepper - Right
##  Connected to MOTOR2
##  Endstop connected to MIN2 - Sensorless homing
[stepper_y]
##    Connected to MOTOR2 (A Motor)
step_pin: DRV2_STEP
dir_pin: DRV2_DIR
enable_pin: !DRV2_EN
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:400             #set to 400 for 0.9 degree stepper
position_min: 0
##--------------------------------------------------------------------

##    Uncomment for 300mm build
position_endstop: 305
position_max: 305

##--------------------------------------------------------------------
homing_positive_dir: true
endstop_pin: tmc2209_stepper_y:virtual_endstop
homing_retract_dist: 0
homing_speed: 75   #Max 100

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: DRV2_UART
#interpolate: true
interpolate: false
run_current: 1.1
sense_resistor: 0.110
stealthchop_threshold: 1
diag_pin: ^M2_STOP
driver_SGTHRS: 150


#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR4
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: DRV4_STEP
dir_pin: DRV4_DIR
enable_pin: !DRV4_EN
rotation_distance: 40
gear_ratio: 9:1
microsteps: 32
##  In Z- Position
#endstop_pin: ^M4_STOP
endstop_pin: probe:z_virtual_endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop: -0.5
##--------------------------------------------------------------------

##    Uncomment below for 300mm build
position_max: 245

##--------------------------------------------------------------------
position_min: -5
homing_speed: 25
second_homing_speed: 5
homing_retract_dist: 3

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: DRV4_UART
interpolate: false
run_current: 0.8
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z1 Stepper - Rear Left
##   Connected to MOTOR5
[stepper_z1]
step_pin: DRV5_STEP
dir_pin: !DRV5_DIR
enable_pin: !DRV5_EN
rotation_distance: 40
gear_ratio: 9:1
microsteps: 32

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: DRV5_UART
interpolate: false
run_current: 0.8
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z2 Stepper - Rear Right
##   Connected to MOTOR6
[stepper_z2]
step_pin: DRV6_STEP
dir_pin: DRV6_DIR
enable_pin: !DRV6_EN
rotation_distance: 40
gear_ratio: 9:1
microsteps: 32

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: DRV6_UART
interpolate: false
run_current: 0.8
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z3 Stepper - Front Right
##   Connected to MOTOR7
[stepper_z3]
step_pin: DRV7_STEP
dir_pin: !DRV7_DIR
enable_pin: !DRV7_EN
rotation_distance: 40
gear_ratio: 9:1
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: DRV7_UART
interpolate: false
run_current: 0.8
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3


#####################################################################
#   Extruder
#####################################################################

#  Connected to Toolhead:E-MOTOR
#  Heater - Toolhead:HE0
#  Thermistor - Toolhead:TH0
[extruder]
step_pin: Toolhead:EXT_STEP
dir_pin: Toolhead:EXT_DIR
enable_pin: !Toolhead:EXT_EN

##    Update value below when you perform extruder calibration
##    If you ask for 100mm of filament, but in reality it is 98mm:
##    rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.6789511           #Bondtech 5mm Drive Gears
#rotation_distance: 53.52022484          #Bondtech LGX Drive Gears
#rotation_distance: 47.088               #Galileo 2 Default
rotation_distance: 47.083291            #Galileo 2 Corrected


##    Update Gear Ratio depending on your Extruder Type
##    Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##    Use 80:20 for M4, M3.1
##    Use 44:14, 37:17 for Bondtech LGX
##    Use 44:10, 37:17 for Bondtech LGX Lite
##    Use 9:1 for Galileo 2
gear_ratio: 9:1                         #Galileo 2
microsteps: 16                          # Was 32 for other extruders.
full_steps_per_rotation: 200            #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: Toolhead:HE0
sensor_pin: Toolhead:TH0
pullup_resistor: 2200
##    Validate the following thermistor type to make sure it is correct
#sensor_type: ATC Semitec 104GT-2    # Dragon
sensor_type: ATC Semitec 104NT-4-R025H42G    # E3D Revo and Phaetus Rapido
min_temp: -50
max_temp: 270
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 250.0
max_extrude_cross_section: 5
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
##    Try to keep pressure_advance below 1.0
pressure_advance: 0.055
#pressure_advance: 0.0475
##    Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040

##    In E0-MOT Position
##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 extruder]
uart_pin: Toolhead:EXT_UART
interpolate: false
tx_pin: Toolhead:EXT_TX
#run_current: 0.5
run_current: 0.45
#hold_current: 0.4
sense_resistor: 0.100
stealthchop_threshold: 0



# [filament_switch_sensor Filament_Entry]
# pause_on_runout: False   # Was true
# #   When set to True, a PAUSE will execute immediately after a runout
# #   is detected. Note that if pause_on_runout is False and the
# #   runout_gcode is omitted then runout detection is disabled. Default
# #   is True.
# runout_gcode:
#   M600
# #   A list of G-Code commands to execute after a filament runout is
# #   detected. See docs/Command_Templates.md for G-Code format. If
# #   pause_on_runout is set to True this G-Code will run after the
# #   PAUSE is complete. The default is not to run any G-Code commands.
# insert_gcode:
#   LOAD_FILAMENT
# #   A list of G-Code commands to execute after a filament insert is
# #   detected. See docs/Command_Templates.md for G-Code format. The
# #   default is not to run any G-Code commands, which disables insert
# #   detection.
# #event_delay: 3.0
# #   The minimum amount of time in seconds to delay between events.
# #   Events triggered during this time period will be silently
# #   ignored. The default is 3 seconds.
# #pause_delay: 0.5
# #   The amount of time to delay, in seconds, between the pause command
# #   dispatch and execution of the runout_gcode. It may be useful to
# #   increase this delay if OctoPrint exhibits strange pause behavior.
# #   Default is 0.5 seconds.
# switch_pin: Toolhead:LIMIT_X
# #   The pin on which the switch is connected. This parameter must be
# #   provided.

# [filament_switch_sensor Filament_Toolhead]
# pause_on_runout: False
# #runout_gcode:
# #insert_gcode:
# #event_delay: 3.0
# #pause_delay: 0.5
# switch_pin: Toolhead:LIMIT_Y



[firmware_retraction]
retract_length: 0.5
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 50
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 30
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

#####################################################################
#   Bed Heater
#####################################################################
[heater_bed]
##    SSR Pin - In BED OUT position
heater_pin: HE1       # SSR Plugged into HE1
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: TB
##    Adjust Max Power so your heater doesn't warp your bed
pwm_cycle_time: 0.01667
max_power: 0.9
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#    Probe
#####################################################################

[probe]
pin: Toolhead:PROBE
#pin: M6_STOP
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 15
samples: 3
sample_retract_dist: 3.0
lift_speed: 20.0
samples_result: median
samples_tolerance: 0.006
samples_tolerance_retries: 3
activate_gcode:
    {% set PROBE_TEMP = 160 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}

[bed_mesh]
speed: 300
horizontal_move_z: 5    # 10 in video
##--------------------------------------------------------------------
##  Uncomment for 300mm build
mesh_min: 10, 10
mesh_max: 290,290
##--------------------------------------------------------------------
fade_start: 0.6
fade_end: 10.0
probe_count: 9,9
algorithm: bicubic     # lagrange in video
#relative_reference_index: 12
#zero_reference_position: 150, 150    # Disabled due to using Tap/Boop.

#####################################################################
#    Fan Control
#####################################################################

[heater_fan hotend_fan]
##    Hotend Fan - Toolhead:FAN_HEF Connector
pin: Toolhead:FAN_HEF
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##    If you are experiencing back flow, you can reduce fan_speed
fan_speed: 0.5

[fan]
##    Print Cooling Fan - can0:FAN2 Connector
pin: Toolhead:FAN_PCF
max_power: 1.0
kick_start_time: 0.5
##    Depending on your fan, you may need to increase this value
##    if your fan will not start. Can change cycle_time (increase)
##    if your fan is not able to slow down effectively
off_below: 0.10

#     [heater_fan controller_fan]
#     ##    Controller fan - FAN0 Connector
#     pin: FAN0
#     max_power: 0.4
#     shutdown_speed: 0.0
#     kick_start_time: 0.5
#     heater: heater_bed
#     heater_temp: 45.0
#     fan_speed: 1.0

[fan_generic chamber_fan]
##  Exhaust fan - In FAN1 Positon
pin: FAN1
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
#fan_speed: 1.0

[temperature_fan CM4]
pin: FAN4
kick_start_time: 0.5
off_below: 0.15
max_power: 1.0
sensor_type: temperature_host
control: pid
min_temp: -10
max_temp: 100
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.1
max_speed: 0.75
target_temp: 40


[controller_fan controller_fan]
#[fan_generic controller_fan]
##  Controller fan - FAN0
pin: FAN0
kick_start_time: 0.5
fan_speed: 1.0
idle_timeout: 30
idle_speed: 1.0
heater: heater_bed


# [heater_fan exhaust_fan]
# ##  Exhaust fan - In E2 OUT Positon
# pin: PB3
# max_power: 1.0
# shutdown_speed: 0.0
# kick_start_time: 5.0
# heater: heater_bed
# heater_temp: 60
# fan_speed: 1.0

#####################################################################
#    LED Control
#####################################################################

#[output_pin caselight]
##  Chamber Lighting - In 5V-RGB Position
#pin: PD3
#pwm: true
#shutdown_value: 0
#value:1.0
#cycle_time: 0.01

[output_pin caselight]
#  Chamber Lighting - In HE3 Position
pin: HE3
pwm: true
#hardware_pwm: true
shutdown_value: 0
value:0.0
cycle_time: 0.01


#####################################################################
#    Homing and Gantry Adjustment Routines
#####################################################################

[quad_gantry_level]
##    Use QUAD_GANTRY_LEVEL to level a gantry.
##    Min & Max gantry corners - measure from nozzle at MIN (0,0) and
##    MAX (250, 250), (300,300), or (350,350) depending on your printer size
##    to respective belt positions
#--------------------------------------------------------------------
##    Gantry Corners for 300mm Build
gantry_corners:
#    -60,-10
#    360,370
    -70,-10
    370,370
#    Probe points
points:
#    50,25
#    50,225
#    250,225
#    250,25
    10,10
    10,290
    290,290
    290,10
#--------------------------------------------------------------------
speed: 450
#speed: 125
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10



[temperature_sensor Chamber_Temp]
sensor_type: ATC Semitec 104GT-2
sensor_pin: TH0
min_temp: 15
#max_temp:


#####################################################################
#   Thermistors
# #####################################################################
## External Chamber Thermistor Port
#[temperature_sensor chamber_temp]
#sensor_type: Generic 3950
#sensor_pin: Toolhead:Chamber
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

[temperature_sensor nh_temp]
## Nitehawk PCB Sensor
sensor_type: CMFB103F3950FANT
sensor_pin: Toolhead:Board
pullup_resistor: 2200
min_temp: 0
max_temp: 100
gcode_id: nh_th




#####################################################################
#    Displays
#####################################################################

#--------------------------------------------------------------------

#[display]
##    mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
##spi_bus: spi1
#spi_software_miso_pin: PA6
#spi_software_mosi_pin: PA7
#spi_software_sclk_pin: PA5

#[neopixel Display]
##    To control Neopixel RGB in mini12864 display
#pin: PC12
#chain_count: 3
#chain_count: 60
#initial_RED: 0.1
#initial_GREEN: 0.5
#initial_BLUE: 0.0
#color_order: RGB

#    Set RGB values on boot up for each Neopixel.
#    Index 1 = display, Index 2 and 3 = Knob
#[delayed_gcode setdisplayneopixel]
#initial_duration: 2
#gcode:
#    SET_LED LED=Display RED=0 GREEN=0 BLUE=1 INDEX=1 TRANSMIT=0        # LED Backlight
#    SET_LED LED=Display RED=0.75 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0     # Knob (Top)
#    SET_LED LED=Display RED=1 GREEN=0 BLUE=0 INDEX=3                   # Knob (Bottom)

#--------------------------------------------------------------------

#####################################################################
#   Lights
#####################################################################
##Stealthburner Headlights
[include stealthburner_leds.cfg]


## PCB Activity Light
[output_pin act_led]
pin: !Toolhead:ACT_LED

#####################################################################
#   Accelerometer
#####################################################################
[adxl345]
axes_map: -z, -y, -x
cs_pin: Toolhead:ADXL_CS
spi_software_sclk_pin: Toolhead:ADXL_SCLK
spi_software_mosi_pin: Toolhead:ADXL_MOSI
spi_software_miso_pin: Toolhead:ADXL_MISO

[resonance_tester]
accel_chip: adxl345
min_freq: 5
max_freq: 133.33
accel_per_hz: 60
probe_points:
    155, 155, 20
sweeping_period: 0



[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 25
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_data: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


[input_shaper]
shaper_freq_x: 49.0    # center frequency for the X axis filter
shaper_type_x: mzv     # filter type for the X axis
shaper_freq_y: 38.4    # center frequency for the Y axis filter
shaper_type_y: mzv     # filter type for the Y axis
damping_ratio_x: 0.046 # damping ratio for the X axis
damping_ratio_y: 0.063 # damping ratio for the Y axis

[skew_correction] 

[servo Blobbifier]
pin: SRV1
#   PWM output pin controlling the servo. This parameter must be
#   provided.
maximum_servo_angle: 180
#   The maximum angle (in degrees) that this servo can be set to. The
#   default is 180 degrees.
minimum_pulse_width: 0.001
#   The minimum pulse width time (in seconds). This should correspond
#   with an angle of 0 degrees. The default is 0.001 seconds.
maximum_pulse_width: 0.002
#   The maximum pulse width time (in seconds). This should correspond
#   with an angle of maximum_servo_angle. The default is 0.002
#   seconds.
#initial_angle:
#   Initial angle (in degrees) to set the servo to. The default is to
#   not send any signal at startup.
#initial_pulse_width:
#   Initial pulse width time (in seconds) to set the servo to. (This
#   is only valid if initial_angle is not set.) The default is to not
#   send any signal at startup.


#####################################################################
#    Macros
#####################################################################
[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x/2} Y{th.axis_maximum.y/2} Z20

[gcode_macro CG28]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}

[gcode_macro M141]
#default_parameter_S: 0
#default_parameter_P: 0
gcode:
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={S|default(0)|int}

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    status_homing
    CG28                      ; Home if not homed to get everything turned on
    status_leveling
    QUAD_GANTRY_LEVEL         ; Level
    status_calibrating_z
    G28 Z                     ; Home the Z now that nozzle is clean
    PARK

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
#    default_parameter_BED: 60 #target bed temperature
#    default_parameter_EXTRUDER: 210 #target extruder temperature
    {% set BED = params.BED|default(60)|int %}
    {% set EXTRUDER = params.EXTRUDER|default(210)|int %}

    SAVE_GCODE_STATE NAME=start

    M117 Starting warmup
    status_heating

    G1 Z20 F1000                       ; move nozzle away from bed
    M117 Warmup
    M190 S{BED}                        ; set bed temp and wait for it reach temp
    M109 S160                          ; Heat to safe temperature for Tap/Boop 

    G32                                ; Home XYZ and do QGL

    status_heating
    M109 S{EXTRUDER}                   ; M109 heat and wait for it to reach temp

    BED_MESH_PROFILE LOAD=default
    SKEW_PROFILE LOAD=CaliFlower

    RESTORE_GCODE_STATE NAME=start
    M117

    status_printing

    SQUIGGLY_PURGE


[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament

    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan

    M117 Print Complete!

    BED_MESH_CLEAR
    SET_SKEW CLEAR=1
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

    status_part_ready


[gcode_macro DISABLE_EXTRUDER]
gcode:
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0

[gcode_macro PARKREAR]
gcode:
    CG28                                                                                         ; home if not already homed
    SAVE_GCODE_STATE NAME=PARKREAR
    G90                                                                                          ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y-10} Z20 F19500     ; park center rear of build volume
    RESTORE_GCODE_STATE NAME=PARKREAR

[gcode_macro PARKBED]
gcode:
    CG28                                                                                         ; home if not already homed
    SAVE_GCODE_STATE NAME=PARKBED
    G90                                                                                          ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z20 F19500      ; park above center of bed
    RESTORE_GCODE_STATE NAME=PARKBED

#[gcode_macro LOAD_FILAMENT]
#gcode:
#    # Parameters
#    {% set d = params.D|default(100)|int %}
#
#    M83              # set extruder to relative extrusion
#    G1 E{d+5} F300   # extrude slowly
#    G1 E-2 F1000     # retract to stop oozing
#    M82              # set extruder to absolute extrusion
#
#
#[gcode_macro UNLOAD_FILAMENT]
#gcode:
#    M83                     # set extruder to relative extrusion
#    G90                     # set toolhead to absolute position
#    G1 Z40 F100000          
#    G1 X{printer.toolhead.axis_maximum.x/2} Y10 F100000     # move up and to front/center to straighten filament path
#    G1 E3   F300            # extrude slowly to soften tip of filament
#    G1 E-30 F100000         # quickly yank filament back clear of hotend
#    G1 E-80 F1800           # ensure filament is clear of extruder gears
#    M82                     # set extruder to absolute extrusion
#
#
### Use the PAUSE macro direct in your M600:
###  e.g. with a different park position front left and a minimal height of 50
#[gcode_macro M600]
#description: Filament change
#gcode: PAUSE X={printer.toolhead.axis_maximum.x/2} Y=10 Z_MIN=30



# ======================================================================================================================



##     Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.184896, 0.231424, 0.275174, 0.305035, 0.299480, 0.271007, 0.231424, 0.211980, 0.193230
#*# 	0.184202, 0.216841, 0.254341, 0.279341, 0.274480, 0.230035, 0.191146, 0.166146, 0.149480
#*# 	0.157813, 0.189757, 0.207813, 0.233507, 0.222396, 0.159202, 0.121007, 0.107118, 0.103646
#*# 	0.131424, 0.156424, 0.164757, 0.173785, 0.117535, 0.074480, 0.059202, 0.062674, 0.070313
#*# 	0.139063, 0.153646, 0.159896, 0.150174, 0.018924, 0.011980, 0.034202, 0.043924, 0.050868
#*# 	0.159202, 0.173091, 0.182813, 0.171702, 0.118924, 0.091146, 0.081424, 0.076563, 0.083507
#*# 	0.182118, 0.189757, 0.200868, 0.193924, 0.168230, 0.136980, 0.120313, 0.111980, 0.107118
#*# 	0.173091, 0.196007, 0.204341, 0.200868, 0.191841, 0.172396, 0.156424, 0.145313, 0.144618
#*# 	0.189063, 0.216146, 0.227257, 0.228646, 0.216146, 0.208507, 0.191841, 0.188368, 0.186285
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 290.0
#*# min_y = 10.0
#*# max_y = 290.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 51.606
#*# pid_ki = 2.867
#*# pid_kd = 232.226
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.658
#*# pid_ki = 1.925
#*# pid_kd = 60.914
#*#
#*# [probe]
#*# z_offset = -0.600
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.0019107980149758823
#*# xz_skew = 0.0
#*# yz_skew = 0.0
