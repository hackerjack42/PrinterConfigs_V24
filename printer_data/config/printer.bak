# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

## Micron Cfg for BigTreeTech OctoPus V1 TMC2209 UART config

## *** THINGS TO CHANGE/CHECK: ***
## MCU paths                            [mcu] section
## Thermistor types                     [extruder] and [heater_bed] sections - See 'sensor types' list at end of file
## Z Endstop Switch location            [safe_z_home] section
## Homing end position                  [gcode_macro G32] section
## Z Endstop Switch  offset for Z0      [stepper_z] section
## Probe points                         [quad_gantry_level] section
## Min & Max gantry corner postions     [quad_gantry_level] section
## PID tune                             [extruder] and [heater_bed] sections
## Thermistor types                     [extruder] and [heater_bed] sections
## Probe pin                            [probe] section
## Fine tune E steps                    [extruder] section

[include fluidd.cfg]

#####################################################################
#   Important other files
#####################################################################

[include Macros/*.cfg]

[include test_probe_accuracy.cfg]

#[temperature_sensor CM4]
#sensor_type: temperature_host
##sensor_path: /sys/class/thermal/thermal_zone0/temp
#min_temp: 10
#max_temp: 100

[temperature_sensor MantaM8P]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100


[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
##--------------------------------------------------------------------
#serial: /dev/serial/by-id/{REPLACE WITH YOUR SERIAL}
#serial: /dev/ttyAMA0
#baud: 250000
#canbus_interface: can0
canbus_uuid: f3b0bfc05fbb
#restart_method: command
##--------------------------------------------------------------------

## can0
[mcu can0]
#canbus_uuid: ac3ad854c4f1 # EBB36
canbus_uuid: 007e88aeda12 # run the following command to locate the uuid >   ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0

[mcu CM4]
serial: /tmp/klipper_host_mcu


[printer]
kinematics: corexy
max_velocity: 3000
#max_velocity: 2000
#max_accel: 7000                         #For ringing test tower
max_accel: 4500                          #Max 4000
#max_accel: 10000                        #For resonance test
#max_accel_to_decel: 10000               #For resonance test
max_z_velocity: 50                      #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0



[board_pins mcu]
    # BTT Manta M8P v1.1
aliases:
aliases_drivers:
    DRV1_EN=PC11, DRV1_STEP=PE2,  DRV1_DIR=PB4,  DRV1_UART=PC10,
    DRV2_EN=PB3,  DRV2_STEP=PF12, DRV2_DIR=PF11, DRV2_UART=PF13,
    DRV3_EN=PF10, DRV3_STEP=PD7,  DRV3_DIR=PD6,  DRV3_UART=PF9,
    DRV4_EN=PD5,  DRV4_STEP=PD3,  DRV4_DIR=PD2,  DRV4_UART=PD4,
    DRV5_EN=PD1,  DRV5_STEP=PC9,  DRV5_DIR=PC8,  DRV5_UART=PD0,
    DRV6_EN=PA15, DRV6_STEP=PA10, DRV6_DIR=PA14, DRV6_UART=PF8,
    DRV7_EN=PD15, DRV7_STEP=PD11, DRV7_DIR=PD9,  DRV7_UART=PD14,
    DRV8_EN=PC7,  DRV8_STEP=PD8,  DRV8_DIR=PC6,  DRV8_UART=PD10
aliases_limitsw:
    M1_STOP = PF4,
    M2_STOP = PF5,
    M3_STOP = PF6,
    M4_STOP = PC0,
    M5_STOP = PC1,
    M6_STOP = PC2
aliases_rgb:
    RGB1    = PA9,
    RGB2    = PB15
aliases_fans:
    FAN0      = PE6,
    FAN1      = PE0,
    FAN2      = PC12,
    FAN3      = PE5,
    FAN4      = PE4,
    FAN5      = PC14,
    FAN5_TACH = PB8,
    FAN6      = PC15,
    FAN6_TACH = PB9
aliases_thermistors:
    TB   = PA0,
    T0   = PA1,
    T1   = PA2,
    T2   = PA3,
    T3   = PA4
aliases_heaters:
    HB   = PB7,
    HE0  = PE3,
    HE1  = PB5,
    HE2  = PB6,
    HE3  = PE1
aliases_exp:
    # EXP1 header
    EXP1_1 = PE9,   EXP1_2  = PE10,
    EXP1_3 = PE11,  EXP1_4  = PE12,
    EXP1_5 = PE13,  EXP1_6  = PE14,    # Slot in the socket on this side
    EXP1_7 = PE15,  EXP1_8  = PB10,
    EXP1_9 = <GND>, EXP1_10 = <5V>,

    # EXP2 header
    EXP2_1 = PB14,  EXP2_2  = PB13,
    EXP2_3 = PF7,   EXP2_4  = PB12,
    EXP2_5 = PE7,   EXP2_6  = PB11,      # Slot in the socket on this side
    EXP2_7 = PE8,   EXP2_8  = <RST>,
    EXP2_9 = <GND>, EXP2_10 = <5V>


#[board_pins EBB36_G0B1_v1.1]
#mcu: can0
#aliases:
#aliases_step:
#    EXT_EN     = PD2,
#    EXT_STEP   = PD0,
#    EXT_DIR    = PD1,
#    EXT_UART   = PA15
#aliases_limitsw: # these are preferred for endstops (including klicky)
#    LIMIT_1    = PB7,
#    LIMIT_2    = PB5,
#    LIMIT_3    = PB6
#aliases_bltouch: # these are the dupont connectors for bltouch
#    PROBE_1    = PB9,
#    PROBE_2    = PB8
#aliases_fans:
#    FAN1       = PA0,
#    FAN2       = PA1
#aliases_thermistors:
#    TH0        = PA3,
#    PT100_CS   = PA4,
#    PT100_SCLK = PA5,
#    PT100_MISO = PA6,
#    PT100_MOSI = PA7
#aliases_heaters:
#    HE0        = PA2
#aliases_rgb:
#    RGBLED     = PD3
#aliases_adxl:
#    ADXL_CS    = PB12,
#    ADXL_SCLK  = PB10,
#    ADXL_MISO  = PB2,
#    ADXL_MOSI  = PB11
#aliases_i2c:
#    AUX0       = PB3,
#    AUX1       = PB4

# can0
#[temperature_sensor EBB36]
#sensor_type: temperature_mcu
#sensor_mcu: can0


#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR1
##  Endstop connected to MIN1 - Sensorless homing
[stepper_x]
step_pin: DRV1_STEP
dir_pin: !DRV1_DIR
enable_pin: !DRV1_EN
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400             #set to 400 for 0.9 degree stepper
position_min: 0
##--------------------------------------------------------------------

##    Uncomment for 300mm build
position_endstop: 300
position_max: 300

##--------------------------------------------------------------------
homing_positive_dir: true
endstop_pin: tmc2209_stepper_x:virtual_endstop
homing_retract_dist: 0
#homing_speed: 16   #Max 100
homing_speed: 40   #Max 100


[tmc2209 stepper_x]
uart_pin: DRV1_UART
interpolate: false
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^M1_STOP
#driver_SGTHRS: 72  # 255 is most sensitive value, 0 is least sensitive
#driver_SGTHRS: 128  # 255 is most sensitive value, 0 is least sensitive
driver_SGTHRS: 255  # 255 is most sensitive value, 0 is least sensitive


##  A Stepper - Right
##  Connected to MOTOR2
##  Endstop connected to MIN2 - Sensorless homing
[stepper_y]
##    Connected to MOTOR2 (A Motor)
step_pin: DRV2_STEP
dir_pin: !DRV2_DIR
enable_pin: !DRV2_EN
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400             #set to 400 for 0.9 degree stepper
position_min: 0
##--------------------------------------------------------------------

##    Uncomment for 300mm build
position_endstop: 300
position_max: 300

##--------------------------------------------------------------------
homing_speed: 80                        #Max 100
homing_retract_dist: 10
homing_positive_dir: true
endstop_pin: tmc2209_stepper_y:virtual_endstop
homing_retract_dist: 0
#homing_speed: 16   #Max 100
homing_speed: 40   #Max 100

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: DRV2_UART
interpolate: False
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^M2_STOP
#driver_SGTHRS: 72  # 255 is most sensitive value, 0 is least sensitive
driver_SGTHRS: 136  # 255 is most sensitive value, 0 is least sensitive
driver_SGTHRS: 255  # 255 is most sensitive value, 0 is least sensitive


#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR4
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: DRV4_STEP
dir_pin: !DRV4_DIR
enable_pin: !DRV4_EN
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
##  In Z- Position
#endstop_pin: ^M4_STOP
endstop_pin: probe:z_virtual_endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop: -0.5
##--------------------------------------------------------------------

##    Uncomment below for 300mm build
position_max: 245

##--------------------------------------------------------------------
position_min: -5
homing_speed: 25
second_homing_speed: 5
homing_retract_dist: 3

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: DRV4_UART
interpolate: false
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z1 Stepper - Rear Left
##   Connected to MOTOR5
[stepper_z1]
step_pin: DRV5_STEP
dir_pin: DRV5_DIR
enable_pin: !DRV5_EN
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: DRV5_UART
interpolate: false
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z2 Stepper - Rear Right
##   Connected to MOTOR6
[stepper_z2]
step_pin: DRV6_STEP
dir_pin: !DRV6_DIR
enable_pin: !DRV6_EN
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##    Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: DRV6_UART
interpolate: false
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3

##  Z3 Stepper - Front Right
##   Connected to MOTOR7
[stepper_z3]
step_pin: DRV7_STEP
dir_pin: DRV7_DIR
enable_pin: !DRV7_EN
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: DRV7_UART
interpolate: false
run_current: 1.0
#hold_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 3


#####################################################################
#   Extruder
#####################################################################

##  Connected to can0:E-MOTOR
##  Heater - can0:HE0
##  Thermistor - can0:TH0
#     [extruder]
#     step_pin: can0:EXT_STEP
#     dir_pin: can0:EXT_DIR
#     enable_pin: !can0:EXT_EN
#     
#     ##    Update value below when you perform extruder calibration
#     ##    If you ask for 100mm of filament, but in reality it is 98mm:
#     ##    rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
#     ##  22.6789511 is a good starting point
#     #rotation_distance: 22.6789511           #Bondtech 5mm Drive Gears
#     rotation_distance: 53.52022484           #Bondtech LGX Drive Gears
#     
#     
#     ##    Update Gear Ratio depending on your Extruder Type
#     ##    Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
#     ##    Use 80:20 for M4, M3.1
#     ##    Use 44:14, 37:17 for Bondtech LGX
#     ##    Use 44:10, 37:17 for Bondtech LGX Lite
#     gear_ratio: 44:14, 37:17                       #LGX Gear Ratio
#     microsteps: 32
#     full_steps_per_rotation: 200            #200 for 1.8 degree, 400 for 0.9 degree
#     nozzle_diameter: 0.400
#     filament_diameter: 1.75
#     heater_pin: can0:HE0
#     sensor_pin: can0:TH0
#     ##    Validate the following thermistor type to make sure it is correct
#     #sensor_type: ATC Semitec 104GT-2    # Dragon
#     sensor_type: ATC Semitec 104NT-4-R025H42G    # E3D Revo
#     min_temp: -50
#     max_temp: 270
#     max_power: 1.0
#     min_extrude_temp: 170
#     max_extrude_only_distance: 250.0
#     control = pid
#     pid_kp = 26.213
#     pid_ki = 1.304
#     pid_kd = 131.721
#     ##    Try to keep pressure_advance below 1.0
#     pressure_advance: 0.055
#     #pressure_advance: 0.0475
#     ##    Default is 0.040, leave stock
#     #pressure_advance_smooth_time: 0.040
#     
#     ##    In E0-MOT Position
#     ##    Make sure to update below for your relevant driver (2208 or 2209)
#     [tmc2209 extruder]
#     uart_pin: can0:EXT_UART
#     interpolate: false
#     #run_current: 0.5
#     run_current: 0.45
#     #hold_current: 0.4
#     sense_resistor: 0.110
#     stealthchop_threshold: 0
#     
#     [firmware_retraction]
#     retract_length: 0.5
#     #   The length of filament (in mm) to retract when G10 is activated,
#     #   and to unretract when G11 is activated (but see
#     #   unretract_extra_length below). The default is 0 mm.
#     retract_speed: 50
#     #   The speed of retraction, in mm/s. The default is 20 mm/s.
#     unretract_extra_length: 0
#     #   The length (in mm) of *additional* filament to add when
#     #   unretracting.
#     unretract_speed: 30
#     #   The speed of unretraction, in mm/s. The default is 10 mm/s.
#     
#     #####################################################################
#     #   Bed Heater
#     #####################################################################
#     [heater_bed]
#     ##    SSR Pin - In BED OUT position
#     heater_pin: HB
#     sensor_type: NTC 100K MGB18-104F39050L32
#     sensor_pin: TB
#     ##    Adjust Max Power so your heater doesn't warp your bed
#     pwm_cycle_time: 0.01667
#     max_power: 0.9
#     min_temp: 0
#     max_temp: 120
#     control: pid
#     pid_kp: 58.437
#     pid_ki: 2.347
#     pid_kd: 363.769
#     
#     #####################################################################
#     #    Probe
#     #####################################################################

[probe]
#pin: can0:LIMIT_3
pin: M6_STOP
x_offset: 0
y_offset: 0
z_offset: 0
speed: 15
samples: 3
sample_retract_dist: 3.0
lift_speed: 20.0
samples_result: median
samples_tolerance: 0.006
samples_tolerance_retries: 3
activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}

[bed_mesh]
speed: 100
horizontal_move_z: 10    # 10 in video
##--------------------------------------------------------------------
##	Uncomment for 300mm build
mesh_min: 40, 40
mesh_max: 260,260
##--------------------------------------------------------------------
fade_start: 0.6
fade_end: 10.0
probe_count: 5,5
algorithm: bicubic     # lagrange in video
#relative_reference_index: 12
zero_reference_position: 150, 150

#####################################################################
#    Fan Control
#####################################################################

#     [heater_fan hotend_fan]
#     ##    Hotend Fan - can0:FAN1 Connector
#     pin: can0:FAN1
#     max_power: 1.0
#     kick_start_time: 0.5
#     heater: extruder
#     heater_temp: 50.0
#     ##    If you are experiencing back flow, you can reduce fan_speed
#     fan_speed: 0.5

#[fan]
###    Print Cooling Fan - can0:FAN2 Connector
#pin: can0:FAN2
#max_power: 1.0
#kick_start_time: 0.5
###    Depending on your fan, you may need to increase this value
###    if your fan will not start. Can change cycle_time (increase)
###    if your fan is not able to slow down effectively
#off_below: 0.10

#     [heater_fan controller_fan]
#     ##    Controller fan - FAN0 Connector
#     pin: FAN0
#     max_power: 0.4
#     shutdown_speed: 0.0
#     kick_start_time: 0.5
#     heater: heater_bed
#     heater_temp: 45.0
#     fan_speed: 1.0

[fan_generic chamber_fan]
##  Exhaust fan - In FAN1 Positon
pin: FAN1
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
#fan_speed: 1.0

[temperature_fan CM4]
pin: FAN5
kick_start_time: 0.5
off_below: 0.15
max_power: 1.0
sensor_type: temperature_host
control: pid
min_temp: -10
max_temp: 100
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.1
max_speed: 0.75
target_temp: 40

# [heater_fan exhaust_fan]
# ##  Exhaust fan - In E2 OUT Positon
# pin: PB3
# max_power: 1.0
# shutdown_speed: 0.0
# kick_start_time: 5.0
# heater: heater_bed
# heater_temp: 60
# fan_speed: 1.0

#####################################################################
#    LED Control
#####################################################################

#[output_pin caselight]
##  Chamber Lighting - In 5V-RGB Position
#pin: PD3
#pwm: true
#shutdown_value: 0
#value:1.0
#cycle_time: 0.01

[output_pin caselight]
#  Chamber Lighting - In HE1 Position
pin: HE1
pwm: true
#hardware_pwm: true
shutdown_value: 0
value:0.0
cycle_time: 0.01


#####################################################################
#    Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 3600

[quad_gantry_level]
##    Use QUAD_GANTRY_LEVEL to level a gantry.
##    Min & Max gantry corners - measure from nozzle at MIN (0,0) and
##    MAX (250, 250), (300,300), or (350,350) depending on your printer size
##    to respective belt positions
#--------------------------------------------------------------------
##    Gantry Corners for 300mm Build
gantry_corners:
    -60,-10
    360,370
#    Probe points
points:
    50,25
    50,225
    250,225
    250,25
#--------------------------------------------------------------------
speed: 450
#speed: 125
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10



#     [temperature_sensor Chamber_Temp]
#     sensor_type: ATC Semitec 104GT-2
#     sensor_pin: T0
#     min_temp: 15
#     #max_temp:

#####################################################################
#    Displays
#####################################################################

#--------------------------------------------------------------------

#[display]
##    mini12864 LCD Display
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
##spi_bus: spi1
#spi_software_miso_pin: PA6
#spi_software_mosi_pin: PA7
#spi_software_sclk_pin: PA5

#[neopixel Display]
##    To control Neopixel RGB in mini12864 display
#pin: PC12
#chain_count: 3
#chain_count: 60
#initial_RED: 0.1
#initial_GREEN: 0.5
#initial_BLUE: 0.0
#color_order: RGB

#    Set RGB values on boot up for each Neopixel.
#    Index 1 = display, Index 2 and 3 = Knob
#[delayed_gcode setdisplayneopixel]
#initial_duration: 2
#gcode:
#    SET_LED LED=Display RED=0 GREEN=0 BLUE=1 INDEX=1 TRANSMIT=0        # LED Backlight
#    SET_LED LED=Display RED=0.75 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0     # Knob (Top)
#    SET_LED LED=Display RED=1 GREEN=0 BLUE=0 INDEX=3                   # Knob (Bottom)

#--------------------------------------------------------------------


#####################################################################
#    Macros
#####################################################################

# ======================================================================================================================



##     Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"
